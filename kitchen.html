<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kitchen Screen</title>

<style>
body{
  font-family: Arial;
  background:#111;
  color:white;
  padding:20px;
}

.order{
  background:#222;
  padding:15px;
  margin:10px 0;
  border-radius:10px;
  transition:0.3s;
}

.pending{border-left:8px solid yellow;}
.preparing{border-left:8px solid blue;}
.done{border-left:8px solid green;}

select{
  font-size:16px;
  padding:5px;
}
</style>
</head>

<body>

<h1>üçú Kitchen Orders</h1>

<div id="orders"></div>

<script>

const SHEET_API =
"https://script.google.com/macros/s/AKfycbxiS-WwDdEI711nSCb6YYYtvYXWsjnh8W1lZ7IkuLWYdrZfSXDRpoatikcT_SUVlcrR/exec";

function loadOrders(){

fetch(SHEET_API + "?t=" + new Date().getTime(), {
  method: "GET",
  mode: "cors"
})

.then(res => res.text())
.then(text => {

  let data = JSON.parse(text);

  let container = document.getElementById("orders");
  container.innerHTML = "";

  if(!data || data.length === 0){
    container.innerHTML = "<h3>No Orders Yet</h3>";
    return;
  }

  data.reverse().forEach(order => {

    let card = document.createElement("div");

   let statusClass = "";

if(order.status == "Pending"){
  statusClass = "pending";
}
else if(order.status == "Preparing"){
  statusClass = "preparing";
}
else if(order.status == "Done"){
  statusClass = "done";
}
else if(order.status == "Cancel"){
  statusClass = "cancel";
}

card.className = "order " + statusClass;

    card.innerHTML = `
      <h2>Table ${order.table}</h2>
      <p>${order.items}</p>
      <h3>RM ${order.total}</h3>
      <p>Status: ${order.status}</p>
      <p class="status ${statusClass}">
  Status: ${order.status}
</p>

<p>Status:</p>

<select onchange="updateStatus('${order.id}',this.value)">
<option ${order.status=="Pending"?"selected":""}>Pending</option>
<option ${order.status=="Preparing"?"selected":""}>Preparing</option>
<option ${order.status=="Done"?"selected":""}>Done</option>
<option ${order.status=="Cancel"?"selected":""}>Cancel</option>
</select>

      <hr>
  <br><br>
<button onclick="printOrder(this)">üñ®Ô∏è Print</button>
    `;

    container.appendChild(card);
  });

})
.catch(err=>{
  console.error("LOAD ERROR:", err);
});

}

 function updateStatus(id, status){

  fetch(SHEET_API, {
    method: "POST",
    headers: {
      "Content-Type": "text/plain;charset=utf-8"
    },
    body: JSON.stringify({
      action: "updateStatus",
      id: id,
      status: status
    })
  })
  .then(()=>console.log("Status sent"))
  .catch(err=>console.error(err));
}

// auto refresh every 5 seconds
setInterval(loadOrders, 5000);

// first load
loadOrders();
  
function printOrder(btn){

  let orderCard = btn.parentElement;

  let printWindow = window.open("", "", "width=300,height=600");

  printWindow.document.write(`
    <html>
    <head>
      <title>Kitchen Ticket</title>

      <style>
        @page {
          size: 80mm auto;
          margin: 0;
        }

        body{
          font-family: monospace;
          width:72mm;
          margin:0;
          padding:5mm;
          font-size:16px;
        }

        button, select{
          display:none;
        }

        hr{
          border-top:1px dashed black;
        }
      </style>
    </head>

    <body>
      ${orderCard.innerHTML}
    </body>
    </html>
  `);

  printWindow.document.close();

  /* ‚úÖ PRINT ONLY AFTER LOAD */
  printWindow.onload = function(){
      printWindow.focus();
      printWindow.print();

      printWindow.onafterprint = function(){
        printWindow.close();
      };
  };
}
</script>
</style>
    </head>
    <body>

      <center>
        <h2>${table}</h2>
      </center>

      <hr>

      <p>${items}</p>

      <hr>

      <h3>${total}</h3>

      <br><br>
      ${new Date().toLocaleString()}

    </body>
    </html>
  `);

  printWindow.document.close();
printWindow.onafterprint = function(){
  printWindow.close();
};
}
</script>

</body>
</html>
