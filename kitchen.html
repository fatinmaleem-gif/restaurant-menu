<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kitchen Screen</title>

<style>
body{
  font-family: Arial;
  background:#111;
  color:white;
  padding:20px;
}

.order{
  background:#222;
  padding:15px;
  margin:10px 0;
  border-radius:10px;
  transition:0.3s;
}

.pending{border-left:8px solid yellow;}
.preparing{border-left:8px solid blue;}
.done{border-left:8px solid green;}

select{
  font-size:16px;
  padding:5px;
}
</style>
</head>

<body>

<h1>üçú Kitchen Orders</h1>

<div id="orders"></div>

<script>

const SHEET_API =
"https://script.google.com/macros/s/AKfycby4sjmDaJfAZu0h7PwZsG9B6-0qtXG2dXMy0c7ZPl3VGBpHU9cTdVZGgEgFQO65OVho/exec";


// =======================
// LOAD ORDERS
// =======================
function loadOrders(){

fetch(SHEET_API + "?t=" + new Date().getTime())
.then(res => res.json())
.then(data => {

let container = document.getElementById("orders");
container.innerHTML = "";

data.reverse().forEach(order => {

let card = document.createElement("div");

let statusClass = (order.status || "Pending").toLowerCase();

card.className = "order " + statusClass;

card.innerHTML = `
<button onclick="printOrder(this)">üñ®Ô∏è Print</button>

<h2>Table ${order.table}</h2>
<p class="items">${order.items}</p>
<h3>RM ${order.total}</h3>

<p class="status">
Status: ${order.status}
</p>

<select onchange="updateStatus('${order.id}',this.value)">
<option ${order.status=="Pending"?"selected":""}>Pending</option>
<option ${order.status=="Preparing"?"selected":""}>Preparing</option>
<option ${order.status=="Done"?"selected":""}>Done</option>
<option ${order.status=="Cancel"?"selected":""}>Cancel</option>
</select>

<hr>
`;

container.appendChild(card);

});

})
.catch(err => console.error("LOAD ERROR:", err));

}


// =======================
// UPDATE STATUS
// =======================
function updateStatus(id, status){

fetch(SHEET_API,{
method:"POST",
headers:{
"Content-Type":"text/plain;charset=utf-8"
},
body: JSON.stringify({
action:"updateStatus",
id:id,
status:status
})
})
.then(()=>console.log("Status Updated"))
.catch(err=>console.error(err));

}


// =======================
// PRINT ORDER
// =======================
function printOrder(btn){

let card = btn.closest(".order");

let table = card.querySelector("h2").innerText;
let items = card.querySelector(".items").innerText;
let total = card.querySelector("h3").innerText;

let printWindow = window.open("", "", "width=300,height=600");

printWindow.document.write(`
<html>
<head>
<title>Kitchen Ticket</title>

<style>
@page{
  size:80mm auto;
  margin:0;
}

body{
  font-family: monospace;
  width:72mm;
  margin:0;
  padding:5mm;
  font-size:16px;
}

h2,h3{
  margin:4px 0;
}

hr{
  border-top:1px dashed black;
  margin:6px 0;
}
</style>

</head>

<body onload="window.print();setTimeout(()=>window.close(),500);">

<center><b>KITCHEN ORDER</b></center>
<hr>

<h2>${table}</h2>
<p>${items}</p>
<h3>${total}</h3>

<p>${new Date().toLocaleString()}</p>

<hr>

</body>
</html>
`);

printWindow.document.close();
}


// =======================
// AUTO REFRESH
// =======================
loadOrders();
setInterval(loadOrders, 5000);

</script>
