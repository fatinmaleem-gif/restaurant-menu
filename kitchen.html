<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kitchen Screen</title>

<style>
body{
  font-family: Arial;
  background:#111;
  color:white;
  padding:20px;
}

.order{
  background:#222;
  padding:15px;
  margin:10px 0;
  border-radius:10px;
  transition:0.3s;
}

.pending{border-left:8px solid yellow;}
.preparing{border-left:8px solid blue;}
.done{border-left:8px solid green;}

select{
  font-size:16px;
  padding:5px;
}
</style>
</head>

<body>

<h1>üçú Kitchen Orders</h1>

<div id="orders"></div>

<script>

const SHEET_API =
"https://script.google.com/macros/s/AKfycbxiS-WwDdEI711nSCb6YYYtvYXWsjnh8W1lZ7IkuLWYdrZfSXDRpoatikcT_SUVlcrR/exec";
  
function loadOrders(){

fetch(SHEET_API + "?t=" + new Date().getTime())
.then(res => res.json())
.then(data => {

let container = document.getElementById("orders");
container.innerHTML = "";

let grouped = {};

data.forEach(order => {

let status = (order.status || "").toLowerCase();

if(status === "pending" && !printedOrders.has(order.id)){

let key = order.table; // group by table

if(!grouped[key]) grouped[key] = [];

grouped[key].push(order);
printedOrders.add(order.id);
}

// ---------- DISPLAY CARD ----------
let card = document.createElement("div");
card.className = "order";

card.innerHTML = `
<h2>Table ${order.table}</h2>
<p>${order.items}</p>
<h3>RM ${order.total}</h3>
<hr>
`;

container.appendChild(card);

});


// =====================
// AUTO BATCH PRINT
// =====================
Object.keys(grouped).forEach(table => {

let orders = grouped[table];

let itemsText = "";
let total = 0;

orders.forEach(o=>{
itemsText += o.items + "\n";
total += Number(o.total);
});

printBatch(table, itemsText, total);

});

})
.catch(err => console.error(err));
}


 function updateStatus(id, status){

  fetch(SHEET_API, {
    method: "POST",
    headers: {
      "Content-Type": "text/plain;charset=utf-8"
    },
    body: JSON.stringify({
      action: "updateStatus",
      id: id,
      status: status
    })
  })
  .then(()=>console.log("Status sent"))
  .catch(err=>console.error(err));
}

// auto refresh every 5 seconds
setInterval(loadOrders, 5000);

// first load
loadOrders();
function printOrder(btn){

  let orderCard = btn.parentElement;

  let printWindow = window.open("", "", "width=300,height=600");

  printWindow.document.write(`
    <html>
    <head>
      <title>Kitchen Ticket</title>

      <style>
        @page {
          size: 80mm auto;
          margin: 0;
        }

        body{
          font-family: monospace;
          width:72mm;
          margin:0;
          padding:5mm;
          font-size:16px;
        }

        button, select{
          display:none;
        }

        hr{
          border-top:1px dashed black;
        }
      </style>
    </head>

    <body>
      ${orderCard.innerHTML}
    </body>
    </html>
  `);

  printWindow.document.close();

  /* ‚úÖ PRINT ONLY AFTER LOAD */
  printWindow.onload = function(){
      printWindow.focus();
      printWindow.print();

      printWindow.onafterprint = function(){
        printWindow.close();
      };
  };
}
</script>

